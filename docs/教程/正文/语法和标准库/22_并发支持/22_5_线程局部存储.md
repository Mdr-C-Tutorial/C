# 线程局部存储

线程局部存储 (Thread-Specific Storage, TSS) 让每个线程持有自己的私有数据副本。它适合存放“线程上下文”这类不应在线程间共享的对象。

本节接口来自 `<threads.h>`，因此也受实现支持度影响；不支持时需要在平台层提供等价封装。

## 1. 核心接口

`tss_create` 创建键，`tss_set` 绑定当前线程的数据指针，`tss_get` 读取当前线程绑定值，`tss_delete` 删除键。创建键时可提供析构函数，在线程退出时自动清理该线程绑定的数据。

```c
#include <stdio.h>
#include <stdlib.h>
#include <threads.h>

static tss_t key;

void cleanup(void *ptr) {
    free(ptr);
}

int worker(void *arg) {
    int id = *(int *)arg;
    int *slot = malloc(sizeof *slot);
    if (slot == NULL) {
        return 1;
    }

    *slot = id * 10;
    tss_set(key, slot);
    printf("thread %d -> %d\n", id, *(int *)tss_get(key));
    return 0;
}

int main(void) {
    thrd_t t1, t2;
    int id1 = 1, id2 = 2;

    if (tss_create(&key, cleanup) != thrd_success) {
        return 1;
    }

    thrd_create(&t1, worker, &id1);
    thrd_create(&t2, worker, &id2);
    thrd_join(t1, NULL);
    thrd_join(t2, NULL);
    tss_delete(key);
    return 0;
}
```

## 2. 适用场景

日志上下文、错误码缓冲、解析器状态等都可放入线程局部存储。它能避免频繁把上下文指针层层透传，也能减少不必要的共享同步。

## 3. 实践建议

线程局部存储适合“小而稳定”的线程私有状态，不适合承载大规模生命周期复杂的数据结构。若对象体积较大或依赖关系复杂，显式上下文传递通常更清楚。
